name: ðŸ”¢ Version Consistency Check

on:
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  version-check:
    name: ðŸ” Check Version Consistency
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: ðŸ” Extract Versions
        id: versions
        run: |
          # Extract version from pyproject.toml
          PYPROJECT_VERSION=$(grep '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
          echo "pyproject_version=$PYPROJECT_VERSION" >> $GITHUB_OUTPUT
          
          # Extract version from backend/__init__.py
          BACKEND_VERSION=$(grep '__version__ = ' backend/__init__.py | sed 's/__version__ = "\(.*\)"/\1/')
          echo "backend_version=$BACKEND_VERSION" >> $GITHUB_OUTPUT
          
          # Extract version from CHANGELOG.md (latest release)
          CHANGELOG_VERSION=$(grep -m 1 '^## \[' CHANGELOG.md | sed 's/## \[\(.*\)\].*/\1/')
          echo "changelog_version=$CHANGELOG_VERSION" >> $GITHUB_OUTPUT

      - name: âœ… Validate Version Consistency
        run: |
          echo "ðŸ” Version Consistency Check"
          echo "=============================="
          echo "PyProject.toml: ${{ steps.versions.outputs.pyproject_version }}"
          echo "Backend __init__: ${{ steps.versions.outputs.backend_version }}"
          echo "Changelog (latest): ${{ steps.versions.outputs.changelog_version }}"
          echo ""
          
          # Check if all versions match
          if [ "${{ steps.versions.outputs.pyproject_version }}" = "${{ steps.versions.outputs.backend_version }}" ]; then
            echo "âœ… PyProject and Backend versions match"
          else
            echo "âŒ Version mismatch between pyproject.toml and backend/__init__.py"
            exit 1
          fi
          
          # Note: Changelog version might be different during development
          echo "â„¹ï¸ Changelog shows latest released version: ${{ steps.versions.outputs.changelog_version }}"

      - name: ðŸ“Š Create Version Summary
        run: |
          echo "## ðŸ”¢ Version Consistency Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Location | Version |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| pyproject.toml | ${{ steps.versions.outputs.pyproject_version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| backend/__init__.py | ${{ steps.versions.outputs.backend_version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CHANGELOG.md (latest) | ${{ steps.versions.outputs.changelog_version }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.versions.outputs.pyproject_version }}" = "${{ steps.versions.outputs.backend_version }}" ]; then
            echo "âœ… **Status:** All tracked versions are consistent" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status:** Version inconsistency detected" >> $GITHUB_STEP_SUMMARY
          fi